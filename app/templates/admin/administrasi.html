{% extends 'include/include.html' %}
{% block pjax_content %}
<head>
<style>
.table-striped > tbody > tr:nth-of-type(odd){
--bs-table-accent-bg:transparent;
}
.table-striped > tbody > tr:nth-of-type(even){
--bs-table-accent-bg:rgba(0,0,0,.05);
}
</style>
</head>
<script>
  function formatRupiah(input) {
    let angka = input.value.replace(/[^,\d]/g, ''); // Menghapus semua karakter selain angka dan koma
    if (angka) {
        let hasil = Number(angka.replace(/,/g, '')).toLocaleString('id-ID'); // Format angka sesuai Indonesia
        input.value = hasil;
    } else {
        input.value = ''; // Jika input tidak valid (semua dihapus), set ke string kosong
    }
  }
    
    function formatNomorTelepon(input) {
      let angka = input.value.replace(/[^0-9]/g, ''); // Menghapus semua karakter selain angka
      let formatted = angka.match(/.{1,3}/g)?.join('-') || ''; // Memisahkan setiap 3 angka dengan tanda -
      input.value = formatted;
    }
    function convertToISO(str) {
    if (!str || str.trim() === "") return null; // Jika kosong, kirim null, jangan diproses
    
    let p = str.split('/');
    if (p.length !== 3) return null; // Jika format bukan dd/mm/yyyy, jangan diproses
    
    // Pastikan tidak ada bagian yang undefined
    let day = p[0];
    let month = p[1];
    let year = p[2];
    
    return `${year}-${month}-${day}`;
  }
  function showModal(title, body, onSubmit) {
    document.getElementById('modal-title').innerText = title;
    document.getElementById('modal-body').innerHTML = body;
    document.getElementById('modal-submit').onclick = onSubmit;
    $('#generic-modal').modal('show');
  }

  function edit(id, performa_belanja, tampil_performa_belanja, tanggal_pembayaran, keterangan_pembayaran, lunas_tidak ) {
    $("#modal-submit").show()
    showModal(
        `Edit Data `,
        `
									  <div class="form-group "> <label for="total">Total </label>
									  <input disabled class="form-control" type="text" name="total" value="Rp ${tampil_performa_belanja}"></div>
									  <div class="form-group"> <label for="tanggal_pembayaran">Tanggal Pembayaran </label>
                    <div class="input-group"> <input type="text" name="tanggal_pembayaran" class="complex-colorpicker form-control" value="${ tanggal_pembayaran }" placeholder="dd/mm/yyyy"> 
                    <span class="input-group-text"> <i data-feather="calendar" class="feather-sm"></i> </span> </div>
									  <div class="form-group"> <label for="keterangan_pembayaran">keterangan Pembayaran</label>
									  <input type="text"class="form-control" name="keterangan_pembayaran" value="${keterangan_pembayaran}"></div>
									  <div class="form-group "> <label for="lunas_tidak">Lunas / Tidak Lunas </label>
									  <select class="form-select form-control" name="lunas_tidak">
									  <option class="form-control" value="" >Pilih Status </option>
									  <option class="form-control" value="Lunas" ${lunas_tidak === 'Lunas' ? 'selected' : ''}>Lunas</option>
									  <option class="form-control" value="Tidak Lunas"  ${lunas_tidak === 'Tidak Lunas' ? 'selected' : ''} >Tidak Lunas</option>
									  </select>
									  </div>
  `,
        function() {
          var data = {
              id_barang_masuk: id,
              amount: performa_belanja,
              tanggal_pembayaran: convertToISO($("[name='tanggal_pembayaran']").val()),
              keterangan_pembayaran: $("[name='keterangan_pembayaran']").val(),
              lunas_tidak: $("[name='lunas_tidak']").val()
          };
        handleAjax(
          '/admin/administrasi/edit/id',
          'PUT',
          data,
          function(response) { handleResponse(response,"Edit","/admin/administrasi")},
          function(xhr, status, error) { console.error("Error:", error);
			handleResponse(xhr.responseJSON,"Edit","/admin/administrasi");
		  }
        );
      }
    );
	 $(".complex-colorpicker").datepicker({
	    autoclose: true,
	    todayHighlight: true,
	    format: "dd/mm/yyyy",   // <-- ini yang bikin format berubah
	    language: "id"          // opsional, kalau kamu include file locale id
	  });
  }

  function hapus(id) {
    if (confirm(`Anda yakin menghapus data ini ?`)) {
      handleAjax(
        '/admin/administrasi/hapus/id',
        'DELETE',
        { id: id },
        function(data) {
			handleResponse(data, "Hapus", "/admin/administrasi");
		},
        function(xhr, status, error) {
			handleResponse(xhr.responseJSON, "Hapus", "/admin/administrasi");
		}
      );
    } else {
      alert('Aksi penghapusan dibatalkan.');
    }
  }

</script>
<div class="page-titles pb-0 ">
  <div class="row ">
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 d-flex align-items-center">
          <li class="breadcrumb-item">
            <a href="index.html" class="link">
              <i class="ri-home-3-line fs-5"></i>
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Data Administrasi</li>
        </ol>
      </nav>
      <h1 class="mb-0 fw-bold">Data Administrasi</h1>
    </div>
    <div class="col-lg-4 col-md-6 d-md-flex align-items-center justify-content-end">
      <a href="{{ url_for('report_administrasi',
      tahun=request.args.get('tahun'),
      bulan=request.args.get('bulan'),
      sales=request.args.get('tanggal'),
      nama_principle=request.args.get('nama_principle')) }}"
      class="btn btn-info d-flex align-items-center ms-2">
      <i class="ri-download-2-line me-2"></i>Report Administrasi</a>
    </div>
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
	  <div class="card-header border-bottom">
          <h4 class="mb-0">Filter:</h4>
        </div>
        <div class="card-body">
          <div class="row col-12 "> 
            <div class="col-12 col-md-10">
              <div class="row g-2">
                
                <div class="col-12 col-sm-6 col-lg-3">
              <select class="form-select select2" 
              style="width: 100%; height: 36px" id="tahun_data" name="tahun">
                <option value="" >Semua Tahun</option>
                {% for i in list_tahun %}
                <option value="{{ i.tahun }}" {% if request.args.get('tahun')|int == i.tahun|int %} selected {% endif %} >{{ i.tahun }}</option>
                {% endfor %}
              </select>
              </div>
            
              <div class="col-12 col-sm-6 col-lg-3">
              <select class="form-select select2" 
              style="width: 100%; height: 36px" id="bulan_data" name="bulan">
                <option  value="" >Semua Bulan</option>
                {% for i in [{"value":"1","nama_bulan":"Januari"},{"value":"2","nama_bulan":"Februari"},{"value":"3","nama_bulan":"Maret"},
                {"value":"4","nama_bulan":"April"},{"value":"5","nama_bulan":"Mei"},{"value":"6","nama_bulan":"Juni"},{"value":"7","nama_bulan":"Juli"},
                {"value":"8","nama_bulan":"Agustus"},{"value":"9","nama_bulan":"September"},{"value":"10","nama_bulan":"Oktober"},
                {"value":"11","nama_bulan":"November"},{"value":"12","nama_bulan":"Desember"}] %}
                <option value="{{ i.value }}" {% if request.args.get('bulan')|int == i.value|int %} selected {% endif %} >{{ i.nama_bulan }}</option>
                {% endfor %}
              </select>
              </div>
            
              <div class="col-12 col-sm-6 col-lg-3">
              <select class="form-select select2 " 
              style="width: 100%; height: 36px" id="tanggal_data" name="tanggal">
                <option value="" >Semua Tanggal</option>
                {% for i in ["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16",
                "17","18","19","20","21","22","23","24","25","26","27","28","29","30","31"] %}
                <option value="{{ i }}"  {% if request.args.get('tanggal')|int == i|int %} selected {% endif %} >{{ i }}</option>
                {% endfor %}
              </select>
              </div>
              
              <div class="col-12 col-sm-6 col-lg-3">
                <select class="form-select select2 " 
                style="width: 100%; height: 36px" id="nama_principle" name="nama_principle">
                  <option value="" >Semua Nama Principle</option>
                    {% for i in data_pabrik %}
                    <option value="{{ i.nama_supplier }}" {% if request.args.get('nama_principle') == i.nama_supplier %} selected {% endif %} >{{ i.nama_supplier }}</option>
                    {% endfor %}
                </select>
                </div>
            </div>
          </div>
        <div class="col-12 col-md-2 ms-md-auto">
          <button type="button" class="btn btn-info w-100" onclick="run()">Submit</button>
        </div>
        </div>
                  <!-- Apply max-height for Transaksi table -->
                  <div class="table-responsive mt-3">
                    <table id="table__data" class="table w-100 table-bordered display table-responsive-stack ">
                    <thead  class="table-light">
                      <tr>
                        <th> No</th>
                        <th> Tanggal Faktur</th> 
                        <th> Nomor Faktur</th>
                        <th > Principle / Supplier</th>
                        <th> Jumlah Total</th>
                        <th > Tanggal Pembayaran</th>
                        <th> Keterangan</th>
                        <th > Lunas / Tidak Lunas</th>
                        <th > Aksi</th>
                        
                      </tr>
                    </thead>
                    <tbody>
                        {% for i in info_list %}
                            <tr class="data-utama">
                              <td data-label="No">{{ (page - 1) * per_page + loop.index }}</td>
                              <td data-label="Tanggal Faktur">{{ i.tglfaktur}}</td>
                              <td data-label="Nomor Faktur">{{ i.nofaktur }}</td>
                              <td data-label="Nama Supplier">{{ i.nama_supplier }}</td>
                              <td data-label="Performa Belanja">
                                  <div class="justify-content-between d-flex w-100">
                                            <div>Rp</div>
                                            <div>{{ i.performa_belanja | format_performa_sales }}</div>
                                        </div>
                              </td>
                                <td data-label="Tanggal Pembayaran">{{ i.tanggal_pembayaran_terakhir or "-" }}
                                </td>

                                <td data-label="Keterangan Pembayaran">{{ i.keterangan_pembayaran or "-" }}
                                </td>

                                <td data-label="Lunas / Tidak">{{ i.status|format_lunas }}
                                </td>
                              <td  data-label="Aksi">
                                  <!-- <button data-bs-toggle="modal" data-bs-target="#modal-{{ i.id }}"
                                  class="btn btn-success">Nota</button> -->
                                  <button class="btn btn-sm btn-warning" onclick="edit({{i.id}}, {{i.performa_belanja}}, '{{i.performa_belanja|format_performa_sales}}', '{{i.tanggal_pembayaran_terakhir|default('-')|format_date}}', '{{i.keterangan_pembayaran|default('-')}}', '{{i.status|format_lunas }}')">Edit</button>
                              </td>
                          </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong>Halaman {{ page }} dari {{ total_pages }}</strong> â€” Total Data: {{ total_records }}
            </div>
            <nav aria-label="Page navigation">
              <ul class="pagination mb-0">

                <!-- Tombol pertama -->
                {% if page > 1 %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1&per_page={{ per_page }}{% for key, value in request.args.items() if key != 'page' %}&{{ key }}={{ value }}{% endfor %}">&laquo; First</a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
                {% endif %}

                <!-- Tombol sebelumnya -->
                {% if has_prev %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page - 1 }}&per_page={{ per_page }}{% for key, value in request.args.items() if key != 'page' %}&{{ key }}={{ value }}{% endfor %}" aria-label="Previous">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                {% endif %}

                <!-- Nomor halaman -->
                {% for p in page_range %}
                  {% if p == page %}
                    <li class="page-item active"><span class="page-link">{{ p }}</span></li>
                  {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ p }}&per_page={{ per_page }}{% for key, value in request.args.items() if key != 'page' %}&{{ key }}={{ value }}{% endfor %}">{{ p }}</a>
                    </li>
                  {% endif %}
                {% endfor %}

                <!-- Tombol selanjutnya -->
                {% if has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page + 1 }}&per_page={{ per_page }}{% for key, value in request.args.items() if key != 'page' %}&{{ key }}={{ value }}{% endfor %}" aria-label="Next">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                {% endif %}

                <!-- Tombol terakhir -->
                {% if page < total_pages %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ total_pages }}&per_page={{ per_page }}{% for key, value in request.args.items() if key != 'page' %}&{{ key }}={{ value }}{% endfor %}">Last &raquo;</a>
                  </li>
                {% else %}
                  <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
                {% endif %}

              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>
<!-- Modal template -->
<div class="modal fade" id="generic-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header d-flex align-items-center">
        <h4 class="modal-title" id="modal-title">Title</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="modal-body">...</div>
      <div class="modal-footer">
        <div class="col-lg-4 col-md-6 d-md-flex align-items-center justify-content-end">
          <a id="modal-submit" class="btn btn-info d-flex align-items-center ms-2">Submit</a>
        </div>
        <button type="button" class="btn btn-light-danger text-danger font-weight-medium waves-effect text-start" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- This Page JS -->
<script>
$(document).ready(function(){ 
	
	 $(".complex-colorpicker").datepicker({
	    autoclose: true,
	    todayHighlight: true,
	    format: "dd/mm/yyyy",   // <-- ini yang bikin format berubah
	    language: "id"          // opsional, kalau kamu include file locale id
	  });
})
function convertToISO(dateStr) {
  // dari "dd/mm/yyyy" ke "yyyy-mm-dd"
  let parts = dateStr.split("/");
  return `${parts[2]}-${parts[1]}-${parts[0]}`;
}
function run() {
	var tahun = document.getElementById('tahun_data').value;
	var bulan = document.getElementById('bulan_data').value;
	var tanggal = document.getElementById('tanggal_data').value;
	var nama_principle = document.getElementById('nama_principle').value;
	
	var queryParams = new URLSearchParams();
	if (tahun !== "tahun") queryParams.append("tahun", tahun);
	if (bulan !== "bulan") queryParams.append("bulan", bulan);
	if (tanggal !== "tanggal") queryParams.append("tanggal", tanggal);
	if (nama_principle !== "nama_principle") queryParams.append("nama_principle", nama_principle);
	url = `?${queryParams.toString()}`
		$.pjax({
			url: url,
			container: '#pjax-container'
		});
	}
	$('#tambah-modal').on('shown.bs.modal', function () {
	$('#nmbarang').select2({
		dropdownParent: $('#tambah-modal') // Pastikan dropdown muncul di dalam modal
	});
	$('#supplier').select2({
		dropdownParent: $('#tambah-modal') // Pastikan dropdown muncul di dalam modal
	});
});
</script>
{% endblock %}
