{% extends 'include/include.html' %}
{% block pjax_content %}
<div class="page-titles pb-0">
  <div class="row">
    <div class="col-lg-8 col-md-6 col-12 align-self-center">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0 d-flex align-items-center">
          <li class="breadcrumb-item">
            <a href="/admin/dashboard" class="link">
              <i class="ri-home-3-line fs-5"></i>
            </a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">Edit Data Pengeluaran Barang</li>
        </ol>
      </nav>
      <h1 class="mb-0 fw-bold">Edit Data Pengeluaran Barang</h1>
    </div>
    <div class="col-lg-4 col-md-6 d-md-flex align-items-center justify-content-end"></div>
  </div>
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">

          <div >

            <!-- Tanggal -->
            <div class="form-group">
              <label for="tglfaktur">Tanggal Faktur</label>
              <div class="input-group">
                <input type="text" id="tglfaktur" class="complex-colorpicker tglfaktur form-control"
                       value="{{ barang_keluar.invoice_date|format_date }}" placeholder="dd/mm/yyyy">
                <span class="input-group-text">
                  <i data-feather="calendar" class="feather-sm"></i>
                </span>
              </div>
            </div>

            <!-- Jatuh Tempo (auto by /api/sales/invoice_no) -->
            <div class="form-group">
              <label for="jthtempo">Jatuh Tempo</label>
              <div class="input-group">
                <input type="text" id="jthtempo" class="form-control" value="{{ barang_keluar.due_date|format_date }}" placeholder="dd/mm/yyyy" disabled>
                <span class="input-group-text">
                  <i data-feather="calendar" class="feather-sm"></i>
                </span>
              </div>
            </div>

            <!-- Nomor Faktur (auto) -->
            <div class="form-group">
              <label for="nofaktur">Nomor Faktur</label>
              <input type="text" id="nofaktur" value="{{ barang_keluar.invoice_no }}" class="form-control" disabled>
            </div>

            <!-- Salesperson -->
            <div class="form-group">
              <label for="namasales">Salesperson</label>
              <select id="namasales" class="select2 form-control" style="width:100%">
                <option value="">Pilih Sales</option>
                {% for s in data_sales %}
                  <option value="{{ s.id or s.name }}"
                          data-name="{{ s.name }}" {% if s.name == barang_keluar.nama_sales %}selected{% endif %}>{{ s.name }}</option>
                {% endfor %}
              </select>
              <input type="hidden" id="idsales" value="{{ barang_keluar.salesperson_id}}">  <!-- simpan id sales terpilih -->
            </div>

            <!-- Metode Pembayaran header (cashtempo) -->
            <div class="form-group">
              <label for="pembayaran">Metode Pembayaran</label>
              <select id="pembayaran" class="form-select">
                <option value="">Pilih</option>
                <option value="Cash"{% if barang_keluar.payment_term == "CASH" %} selected{% endif %}>Cash</option>
                <option value="Tempo"{% if barang_keluar.payment_term == "TEMPO" %} selected{% endif %}>Tempo</option>
              </select>
            </div>

            <!-- Outlet (terfilter oleh salesperson) -->
            <div class="form-group">
              <label for="namaoutlet">Outlet</label>
              <select id="namaoutlet" class="form-control select2" style="width:100%">
                <option value="{{barang_keluar.nama_outlet }}" selected >{{barang_keluar.nama_outlet }}</option>
              </select>
              <small class="text-muted">Cari nama/alamat outlet.</small>
              <input type="hidden" id="idoutlet" value="{{barang_keluar.id_outlet}}">
            </div>

            <!-- Alamat outlet (readonly) -->
            <div class="form-group">
              <label for="alamatoutlet">Alamat Outlet</label>
              <input type="text" id="alamatoutlet" class="form-control" value="{{barang_keluar.alamat_outlet}}" disabled>
            </div>

            <!-- Pajak -->
            <div class="form-group">
              <label for="pajak">Pajak</label>
              <select id="pajak" class="form-select">
                <option value="">Pilih pajak</option>
                <option value="Iya" {% if barang_keluar.tax_flag == "Iya"  %}selected{% endif %}>Iya</option>
                <option value="Tidak" {% if barang_keluar.tax_flag == "Tidak" %}selected{% endif %} >Tidak</option>
              </select>
            </div>

            <!-- Sender-->
            <div class="form-group">
              <label for="namapengirim">Pengirim</label>
              <select id="namapengirim" class="select2 form-select" style="width:100%">
                <option value="">Tidak ada Pengirim</option>
                {% for s in data_pengirim %}
                  <option value="{{ s.id or s.name }}"
                          data-name="{{ s.name }}" {% if s.name == barang_keluar.nama_pengirim %}selected{% endif %} >{{ s.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- REPEATER ITEM -->
            <div class="email-repeater mb-3">
              <div data-repeater-list="items">
                {% for detail in items %}
                <div data-repeater-item class="row mb-3 bg-light border-top mt-4 p-3 rounded-3">
                  <!-- Barang (value = id_barang, tampil stock & limit) -->
                  <div class="form-group">
                    <label>Nama Barang</label>
                    <select class="form-control select2 sel-barang" style="width:100%">
                      <option value="">Pilih Barang</option>
                      {% for b in data_barang %}
                        <option
                          value="{{ b.id }}"
                          data-kode="{{ b.code }}"
                          data-qty="{{ b.unit }}"
                          data-stok="{{ b.qty_on_hand }}"
                          data-limit="{{ b.stock_min }}"
                          {% if b.name == detail.name %}selected{%endif%}
                        >{{b.name}}</option>
                      {% endfor %}
                    </select>
                    <small class="text-muted d-block">
                      <span class="hint-stok">Stok: -</span> •
                      <span class="hint-limit">Limit: -</span>
                    </small>
                  </div>

                  <input type="hidden" class="idbarang" value="{{ detail.product_id }}">
                  <input type="text" class="qty form-control d-none" disabled>

                  <div class="form-group">
                    <label>Jumlah Permintaan</label>
                    <input type="number" min="0" class="jmlpermintaan form-control" placeholder="0" value="{{ detail.qty }}">
                  </div>

                  <div class="form-group">
                    <label>Harga Satuan</label>
                    <div class="input-group">
                      <span class="input-group-text">Rp</span>
                      <input type="text" class="hargasatuan form-control" placeholder="0" oninput="formatAngkaInput(this)" value="{{ detail.unit_price_decimal }}">
                      <input type="text" class="hargasatuan-koma form-control" maxlength="3" placeholder=",00" oninput="this.value = formatKoma(this.value)" value="{{ detail.unit_price_decimal_koma }}">
                    </div>
                  </div>

                  <div class="form-group">
                    <label>Diskon (%)</label>
                    <div class="input-group">
                      <input type="number" class="diskon form-control" min="0" max="100" placeholder="0" oninput="formatDiskon(this)"value="{{ detail.discount_percent_decimal }}">
                      <span class="input-group-text">%</span>
                    </div>
                  </div>

                  <div class="form-group">
                    <label>Harga Total</label>
                    <div class="input-group">
                      <span class="input-group-text">Rp</span>
                      <input type="text" class="hargatotal form-control" placeholder="0" disabled value="{{ detail.total_amount_decimal }}">
                      <input type="text" class="hargatotal-koma form-control" maxlength="3" placeholder=",00" disabled value="{{ detail.total_amount_decimal_koma }}">
                    </div>
                  </div>

                  <div class="p-3 mt-3 mb-3 rounded-3" style="background-color: #f8f9fa; border: 1px dashed #dee2e6;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <h6 class="mb-0 fw-bold text-primary">Simulasi Profit <small class="text-danger fw-italic" style="font-size: 0.75rem;">(data ini tidak disimpan)</small></h6>
                      <small></small>
                    </div>
                    
                    <div class="row">
                      <div class="col-md-4">
                        <div class="form-group">
                          <label class="small fw-bold">HPP Satuan</label>
                          <div class="input-group input-group-sm">
                            <span class="input-group-text">Rp</span>
                            <input type="text" class="hpp form-control" placeholder="0" oninput="formatAngkaInput(this)">
                            <input type="text" class="hpp-koma form-control" maxlength="3" placeholder=",00" oninput="this.value = formatKoma(this.value)" style="max-width: 60px;">
                          </div>
                        </div>
                      </div>
                  
                      <div class="col-md-4">
                        <div class="form-group">
                          <label class="small fw-bold">Total HPP</label>
                          <div class="input-group input-group-sm">
                            <span class="input-group-text">Rp</span>
                            <input type="text" class="totalhpp form-control" placeholder="0" disabled>
                            <input type="text" class="totalhpp-koma form-control" maxlength="3" placeholder=",00" disabled style="max-width: 60px;">
                          </div>
                        </div>
                      </div>
                  
                      <div class="col-md-4">
                        <div class="form-group">
                          <label class="small fw-bold">Estimasi Profit</label>
                          <div class="input-group input-group-sm">
                            <span class="input-group-text bg-success text-white">Rp</span>
                            <input type="text" class="profit form-control fw-bold text-success" placeholder="0" disabled>
                            <input type="text" class="profit-koma form-control fw-bold text-success" maxlength="3" placeholder=",00" disabled style="max-width: 60px;">
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="form-group">
                    <label>Batch</label>
                    <input type="text" id="batch" value="{{detail.batch_no}}" class="batch form-control">
                  </div>

                  <div class="form-group">
                    <label>Expired Date (ED)</label>
                    <div class="input-group">
                    <input type="text" id="ed" value="{{ detail.expired_date }}" class="complex-colorpicker2 ed form-control"
                       placeholder="mm/yyyy">
                    <span class="input-group-text">
                      <i data-feather="calendar" class="feather-sm"></i>
                    </span>
                    <input type="hidden" id="ed_database" value="{{ detail.expired_date }}" class="ed_database">
                    </div>
                  </div>

                  <button data-repeater-delete class="mt-2 btn btn-danger w-100" type="button">
                    <i data-feather="x-circle" class="feather-sm me-1"></i> Hapus Barang
                  </button>
                </div>
                {% endfor %}
              </div>

              <button type="button" data-repeater-create id="tambah-barang" class="btn btn-info w-100">
                <i data-feather="plus-circle" class="feather-sm me-1"></i> Tambah Barang
              </button>
            </div>

            <div class="text-end mt-3">
              <button id="modal-submit-tambah" class="btn btn-info ms-2">Submit</button>
              <a href="/admin/pengeluaran" class="btn btn-secondary">Back</a>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script>
  
$('a[href="/admin/pengeluaran"]').addClass("active");
  // Repeater
  $(".email-repeater").repeater({
    show: function () {
      $(this).slideDown();
      initSelect2Barang($(this).find('.sel-barang'));
    },
    hide: function (remove) {
      if (confirm("Hapus item ini?")) $(this).slideUp(remove);
    },
  });
  $(".select2").select2();

  // Datepicker dd/mm/yyyy
  $(".complex-colorpicker").datepicker({
    autoclose: true,
    todayHighlight: true,
    format: "dd/mm/yyyy",
    language: "id"
  });
  $(".complex-colorpicker2").datepicker({
    autoclose: true,
    todayHighlight: true,
    format: "mm/yyyy",
    language: "id"
  });
// Memastikan format yang dikirim ke Python selalu YYYY-MM-DD
function convertToISO(str) {
    if (!str || str.trim() === "" || str.includes('undefined')) return null;
    
    // Jika sudah format ISO (YYYY-MM-DD), langsung kembalikan
    if (str.includes('-') && str.split('-')[0].length === 4) return str;

    // Jika format Indonesia (DD/MM/YYYY)
    if (str.includes('/')) {
        let p = str.split('/');
        if (p.length === 3) return `${p[2]}-${p[1]}-${p[0]}`;
    }
    return str;
}

// Memastikan format ED (Expired Date) aman
function convertmmyyyy(str) {
    if (!str || str.trim() === "" || str.includes('undefined')) return null;
    
    // Jika sudah format database (biasanya MM-YYYY atau YYYY-MM-DD)
    if (str.includes('-')) return str;

    // Jika format input (MM/YYYY)
    if (str.includes('/')) {
        let p = str.split('/');
        if (p.length === 2) return `${p[0]}-${p[1]}`; // Menghasilkan MM-YYYY
    }
    return str;
}

function bersihkanFormatAngka(s) {
    if (!s) return "0";
    // Menghapus titik ribuan agar menjadi string angka murni
    return s.toString().replace(/\./g, "");
}

  // Recalc jatuh tempo + no faktur saat tanggal diubah
  $("#tglfaktur").on("change", function(){
    const tgl = $(this).val();
    if(!tgl) return;
    const encoded = encodeURIComponent(tgl);
    $.getJSON(`/api/sales/invoice_no/${encoded}`, function(resp){
      $("#jthtempo").val(resp.jatuh_tempo);
      $("#nofaktur").val(resp.nofaktur);
    });
  });

  // ===== Select2 helpers =====
  function select2OutletTemplate(opt){
    if(!opt.id) return opt.text;
    const el = opt.element;
    const addr = el?.dataset?.address || '';
    const $tpl = $(`
      <div>
        <div>${opt.text}</div>
        <div class="text-muted small">${addr || '(alamat tidak tersedia)'}</div>
      </div>
    `);
    return $tpl;
  }

  function select2BarangTemplate(opt){
    if(!opt.id) return opt.text;
    const el = opt.element;
    const stok = el?.dataset?.stok || '-';
    const limit = el?.dataset?.limit || '-';
    const kode = el?.dataset?.kode || '';
    const qty = el?.dataset?.qty || '';
    const $tpl = $(`
      <div>
        <div>${opt.text} <span class="text-muted">(${kode})</span></div>
        <div class="text-muted small">Stok: ${stok} ${qty} • Limit: ${limit}</div>
      </div>
    `);
    return $tpl;
  }

  function initSelect2Barang($el){
    $el.select2({
      width: '100%',
      placeholder: 'Pilih barang…',
      templateResult: select2BarangTemplate,
      templateSelection: select2BarangTemplate,
      matcher: function(params, data){
        if ($.trim(params.term) === '') return data;
        const term = params.term.toLowerCase();
        const text = (data.text || '').toLowerCase();
        const kode = (data.element?.dataset?.kode || '').toLowerCase();
        const stok = (data.element?.dataset?.stok || '').toLowerCase();
        return (text.includes(term) || kode.includes(term) || stok.includes(term)) ? data : null;
      }
    });
  }

  // Inisialisasi Select2 global
  $('#namasales').select2({ width: '100%', placeholder: 'Pilih sales…' });
  $('#namapengirim').select2({ width: '100%', placeholder: 'Pilih pengirim…' });
  $('#namaoutlet').select2({
    width:'100%',
    placeholder:'Pilih outlet…',
    templateResult: select2OutletTemplate,
    templateSelection: select2OutletTemplate,
    matcher: function(params, data){
      if ($.trim(params.term) === '') return data;
      const term = params.term.toLowerCase();
      const text = (data.text || '').toLowerCase();
      const addr = (data.element?.dataset?.address || '').toLowerCase();
      return (text.includes(term) || addr.includes(term)) ? data : null;
    }
  });
  $('.sel-barang').each(function(){ initSelect2Barang($(this)); });

  // Saat pilih salesperson → load daftar outlet (by API yang sudah kamu punya)
  // Asumsi endpoint GET: /admin/salespersons/<sp_id>/customers → [{customer_id, name, address}]
  $("#namasales").on("change", function(){
    const spId = $(this).val();
    const spName = $('#namasales option:selected').data('name') || '';
    $("#idsales").val(spId || '');
    const $out = $("#namaoutlet");
    $("#idoutlet").val('');
    $("#alamatoutlet").val('');
    $out.empty().append('<option value="">Pilih Outlet</option>').trigger('change');

    if(!spId) return;

    $.getJSON(`/admin/salespersons/${spId}/customers`, function(rows){
      // rows: [{customer_id, name, address}]
      const frag = document.createDocumentFragment();
      rows.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r.customer_id;
        opt.text = r.name;
        opt.dataset.address = r.address || '';
        frag.appendChild(opt);
      });
      $out.append(frag).trigger('change');
    }).fail(function(xhr){
      console.error('Gagal load outlet:', xhr.responseText);
      alert('Gagal memuat outlet untuk sales terpilih.');
    });
  });
  // Outlet terpilih → set id & alamat
  $("#namaoutlet").on("change", function(){
    const $opt = $(this).find('option:selected');
    $("#idoutlet").val($opt.val() || '');
    $("#alamatoutlet").val($opt.data('address') || '');
  });

  // Saat pilih barang di repeater → isi hidden id + hint stok/limit
  $(document).on('change', '.sel-barang', function(){
    const $row = $(this).closest('[data-repeater-item]');
    const $opt = $(this).find('option:selected');
    $row.find('.idbarang').val($opt.val() || '');
    $row.find('.qty').val($opt.data('qty') || '');
    $row.find('.hint-stok').text('Stok: ' + ($opt.data('stok') ?? '-'));
    $row.find('.hint-limit').text('Limit: ' + ($opt.data('limit') ?? '-'));
  });

  // ===== Format angka utilities (pakai versi kamu) =====
  function formatKoma(val){
    val = val.replace(/[^\d,]/g, '');
    if (val.length > 0 && val[0] !== ',') val = ',' + val.replace(',', '');
    val = val.slice(0, 3);
    if (!/^,\d{0,2}$/.test(val)) val = val.slice(0,-1);
    return val;
  }
  function splitKomaValue(num){
    let v = parseFloat(num || 0).toFixed(2);
    let [depan, belakang] = v.split(".");
    depan = depan.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return { int: depan, koma: ',' + belakang };
  }
  function formatAngkaInput(el){
    let angka = (el.value||'').replace(/\./g, "");
    el.value = formatAngka(angka);
  }
  function formatAngka(angka){
    angka = angka.toString();
    let number_string = angka.replace(/[^,\d]/g, "").toString();
    let split = number_string.split(",");
    let sisa = split[0].length % 3;
    let hasil = split[0].substr(0, sisa);
    let ribuan = split[0].substr(sisa).match(/\d{3}/g);
    if (ribuan) {
      let separator = sisa ? "." : "";
      hasil += separator + ribuan.join(".");
    }
    return hasil;
  }
  function formatDiskon(input){
    let angka = input.value.replace(/[^,\d]/g, '');
    if (!angka){ input.value=''; return; }
    angka = parseInt(angka,10);
    input.value = (angka>=0 && angka<=100) ? angka : '';
  }

  // Auto-hitungan total/hpp/profit
  $(document).on("input", ".jmlpermintaan, .hargasatuan, .hargasatuan-koma, .diskon, .hpp, .hpp-koma", function(){
    const $row = $(this).closest("[data-repeater-item]");
    const jumlah = parseFloat(($row.find('.jmlpermintaan').val()||'0').replace(',', '.')) || 0;

    const hs_int  = bersihkanFormatAngka($row.find('.hargasatuan').val()||'0');
    const hs_koma = ($row.find('.hargasatuan-koma').val()||',00').replace(',','') || '00';
    const harga_satuan = parseFloat(`${hs_int}.${hs_koma}`) || 0;

    const hpp_int  = bersihkanFormatAngka($row.find('.hpp').val()||'0');
    const hpp_koma = ($row.find('.hpp-koma').val()||',00').replace(',','') || '00';
    const hpp = parseFloat(`${hpp_int}.${hpp_koma}`) || 0;

    const diskon = parseFloat($row.find('.diskon').val()||'0') || 0;

    let harga_total = jumlah * harga_satuan;
    if (diskon) harga_total -= harga_total * (diskon/100);

    const total_hpp = jumlah * hpp;
    const profit = harga_total - total_hpp;

    const t = splitKomaValue(harga_total);
    const h = splitKomaValue(total_hpp);
    const p = splitKomaValue(profit);

    $row.find('.hargatotal').val(t.int);
    $row.find('.hargatotal-koma').val(t.koma);
    $row.find('.totalhpp').val(h.int);
    $row.find('.totalhpp-koma').val(h.koma);
    $row.find('.profit').val(p.int);
    $row.find('.profit-koma').val(p.koma);
  });

  // Trigger periodik supaya nilai keep-in-sync
  setInterval(function(){
    $(".jmlpermintaan, .hargasatuan, .diskon, .hpp").trigger("input");
  }, 2500);

  // Submit
  $("#modal-submit-tambah").on("click", function(){
    let cancel = false;

    const payload = {
      invoice_date: convertToISO($("#tglfaktur").val()),
      due_date: convertToISO($("#jthtempo").val())||"{{barang_keluar.due_date}}"||"",
      invoice_no: $("#nofaktur").val(),
      // tetap kirim nama (kompatibel backend lama) + id (skema baru)
      nama_sales: $('#namasales option:selected').data('name') || '',
      nama_pengirim: $('#namasales option:selected').data('name') || '',
      id_sales: $("#idsales").val() || null,
      nama_outlet: $('#namaoutlet option:selected').text() || '',
      id_outlet: $("#idoutlet").val() || null,
      pembayaran: $("#pembayaran").val(),
      pajak: $("#pajak").val(),
      items: []
    };

    // Validasi dasar
    if(!payload.id_sales || !payload.id_outlet){
      alert("Pilih sales & outlet terlebih dahulu.");
      return;
    }

    // Data barang dari server (untuk cek stok-limit warning)
    const data_barang = {{ data_barang | tojson | safe }};

    $("[data-repeater-item]").each(function(){
      if (cancel) return;
      const $row = $(this);
      const id_barang = $row.find(".sel-barang").val();
      if(!id_barang) return; // skip baris kosong

      // cek stok warning
      const jml = parseInt($row.find(".jmlpermintaan").val()||'0',10);
      const found = data_barang.find(b => String(b.id) === String(id_barang));
      if(found){
        const sisa = (found.qty_on_hand||0) - jml;
        if (sisa <= (found.stok_min||0)){
          if(!confirm("Stok akan melewati limit! Lanjutkan?")) { cancel = true; return false; }
        }
      }

      const hs = bersihkanFormatAngka($row.find(".hargasatuan").val()||'0') + '.' + ($row.find(".hargasatuan-koma").val().replace(',','')||'00');
      const ht = bersihkanFormatAngka($row.find(".hargatotal").val()||'0') + '.' + ($row.find(".hargatotal-koma").val().replace(',','')||'00');
     
      payload.items.push({
        id_barang: id_barang,
		    unit_label: $row.find(".sel-barang")?.dataset?.qty || '',
        jmlpermintaan: $row.find(".jmlpermintaan").val()||"0",
        harga_satuan: hs,
        diskon: $row.find(".diskon").val()||"0",
        harga_total: ht,
        batch_no: $row.find(".batch").val()||"",
        ed: convertmmyyyy($row.find(".ed").val())||$row.find(".ed_database").val()||"",
      });
    });

    if(cancel) return;

    $.ajax({
      url: window.location.pathname,
      method: 'PUT',
      data: JSON.stringify(payload),
	  contentType: 'application/json',
	  success: function(data){
		handleResponse(data,'Edit Data Pengeluaran',"/admin/pengeluaran")
      },
      error: function(xhr){
		handleResponse(xhr,'Edit Data Pengeluaran',"/admin/pengeluaran")
		
      }
    });
  });
  
  $("#tambah-barang").on("click", function() {
            console.log("halol");
            setTimeout(function() {
                $(".nmbarang").select2();
                $('span[data-select2-id="3"]').hide();
                const observer = new MutationObserver(function(mutationsList, observer) {
                    const element = document.querySelector('span[data-select2-id="5"]');
                    if (element) {
                        element.style.display = 'none';
                        observer.disconnect(); // Hentikan observer setelah elemen ditemukan
                    }
                });
                observer.observe(document.body, {
                    childList: true,
                    subtree: true
                });
                $(".complex-colorpicker2").datepicker({
                    autoclose: true,
                    todayHighlight: true,
                    format: "mm/yyyy",
                    language: "id"
                  });
            }, 1000);
        });
</script>
{% endblock %}